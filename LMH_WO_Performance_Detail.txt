/*
 * ** For Emergency **
 -- work orders 30 minute to respond during the workday, 1 hour after hours and weekends to RESPOND, NO COMPLETE
 ** For Routine **
 -- they have to respond and complete within 24 hours or the end of the next business day WHICHEVER IS GREATER 
 -- response and complete
 -- they want the first contact time
 ** NO URGENT **
*/
//SELECT NO CRYSTAL 

IF OBJECT_ID('lmhwohistorytemp') IS NOT NULL
	DROP TABLE lmhwohistorytemp

//END SELECT 

//SELECT NO CRYSTAL 
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;

WITH CTE
AS (
	SELECT 1 AS 'KeyColumn'
		,DENSE_RANK() OVER (
			PARTITION BY wo.hmy ORDER BY wo.hmy
				,fc.tstamp
			) rownum
		,wo.hmy wonum
		,p.scode PropCode
		,wh.sStatus AS 'HistoryStatus'
		,FORMAT(wo.dtCall, 'M/dd/yyyy hh:mm tt') dtCall
		,FORMAT(FC.tstamp, 'M/dd/yyyy hh:mm tt') AS 'HistoryDate'
		,FORMAT(ISNULL(MIN(wod.dtActStart), wo.dtWCompl), 'M/dd/yyyy hh:mm tt') workstart
		,FORMAT(ISNULL(MIN(wod.dtActStart), wo.dtWCompl), 'M/dd/yyyy hh:mm tt') ResponseDate
		,FORMAT(ISNULL(MAX(wod.dtActFinish), wo.dtWCompl), 'M/dd/yyyy hh:mm tt') CompletionDate
		,DATENAME(WEEKDAY, wo.dtcall) AS 'DayOfCall'
		,isnull(wo.sPriority, '') Priority
		,CASE 
			WHEN isnull(rtrim(wo.sStatus), 'NONE') IN (
					'NONE'
					,'NULL'
					,''
					)
				THEN 'NONE'
			ELSE wo.sStatus
			END 'STATUS'
		,count(DISTINCT wo.hMy) Count
		,CASE 
			WHEN lmh.complete_goal = 0
				THEN 'Yes'
			WHEN lmh.pending_reason NOT LIKE 'Qualified%'
				THEN 'Yes'
			ELSE 'No'
			END JerrodGoal
		,wh.hmy WOHistoryId
		,wo.spriority
		,wo.scategory Category
		,wo.ssubcat subcategory
		,FORMAT(wo.dtwcompl, 'M/dd/yyyy hh:mm tt') AS 'dtcompl'
		,dbo.FormatPhoneNumber(wo.sphone) AS 'phone'
		,wo.sbriefdesc
		,wo.sfulldesc
		,wo.stechnotes
		,wo.scallername
		,u.scode uscode
		,p.scode pscode
		,DATENAME(MONTH, wo.dtcall) AS 'Month'
		,'#@@OutputType#' AS 'OutputType'
	FROM mm2wO wo
	LEFT JOIN lmhwodata lmh ON lmh.hmy = wo.hmy
	LEFT JOIN mm2wodet wod ON wo.hmy = wod.hwo
	LEFT JOIN property p ON (p.hmy = wo.hproperty)
	LEFT JOIN unit u ON (wo.hunit = u.hmy)
	LEFT JOIN building b ON (wo.hbuilding = b.hmy)
	LEFT JOIN vendor v ON (wo.hVendor = v.hmyperson)
	LEFT JOIN mm2wotmpl tmpl ON (wo.htmpl = tmpl.hmy)
	LEFT JOIN mmasset asset ON (wo.hasset = asset.hmy)
	LEFT JOIN person emp ON (wod.hperson = emp.hmy)
	LEFT JOIN MM2EMPLRATES skill ON (wod.hrate = skill.hmy)
	LEFT JOIN WOHistory wh ON wh.hWO = WO.HMY
	INNER JOIN (
		SELECT MIN(wh.hmy) whHmy
			,wh.hwo
			,wh.sStatus WOStatus
			,wh.dtUserModified AS 'tstamp'
			,isnull(pu.uName, 'DBO') UserName
		FROM WOHistory wh
		LEFT JOIN pmuser pu ON pu.hmy = wh.hUserModifiedBy
		GROUP BY wh.sStatus
			,isnull(pu.uName, 'DBO')
			,wh.hWO
			,wh.dtUserModified
		) FC ON FC.whHmy = wh.hMy
	WHERE (
			wo.SPRIORITY LIKE '%Emergency%'
			OR wo.SPRIORITY LIKE '%Routine%'
			) #CONDITIONS#
	GROUP BY ISNULL(wo.sPriority, '')
		,CASE 
			WHEN ISNULL(RTRIM(wo.sStatus), 'NONE') IN (
					'NONE'
					,'NULL'
					,''
					)
				THEN 'NONE'
			ELSE wo.sStatus
			END
		,wo.DTCALL
		,wo.DTWCOMPL
		,FC.tstamp
		,wo.SPRIORITY
		,wo.HMY
		,wo.SSTATUS
		,wh.sStatus
		,lmh.complete_goal
		,lmh.pending_reason
		,wh.sStatus
		,p.scode
		,wh.hmy
		,wo.spriority
		,wo.scategory
		,wo.ssubcat
		,FORMAT(wo.dtwcompl, 'M/dd/yyyy hh:mm tt')
		,dbo.FormatPhoneNumber(wo.sphone)
		,wo.sbriefdesc
		,wo.sfulldesc
		,wo.stechnotes
		,wo.scallername
		,u.scode
		,p.scode
		,DATENAME(MONTH, wo.dtcall)
	)
SELECT *
INTO lmhwohistorytemp
FROM CTE
ORDER BY wonum
	,rownum

/*WHERE STATUS IN ('Pending / Vendor','Pending / Parts', 'Pending / Appointment', 'Pending / Continuous Work')*/

//END SELECT 

//SELECT Detail 
WITH CTE
AS (
	SELECT CASE 
			WHEN DENSE_RANK() OVER (
					PARTITION BY wonum ORDER BY wonum
						,historydate
					) = 1
				THEN 1
			ELSE 0
			END orderby
		,*
	FROM lmhwohistorytemp
	WHERE historystatus = 'First Contact'
	)
SELECT *
/*KeyColumn
	,rownum
	,wonum
	,PropCode
	,HistoryStatus
	,dtCall
	,HistoryDate
	,workstart
	,ResponseDate
	,CompletionDate
	,DayOfCall
	,Priority
	,[STATUS]
	,[Count]
	,JerrodGoal
	,WOHistoryId
	,spriority
	,Category
	,subcategory
	,dtcompl
	,phone
	,sbriefdesc
	,sfulldesc
	,stechnotes
	,scallername
	,uscode
	,pscode
	,[Month]
	,OutputType*/
	,CASE 
		WHEN [Priority] LIKE '%Emergency%'
			AND (
				(
					DayOfCall = 'Saturday'
					OR DayOfCall = 'Sunday'
					)
				OR (
					(
						DATEPART(HOUR, dtcall) BETWEEN 19
							AND 23
						OR DATEPART(HOUR, dtcall) BETWEEN 0
							AND 7
						)
					)
				)
			AND DATEDIFF(MINUTE, dtcall, HistoryDate) <= 60
			THEN 'Yes'
		WHEN [Priority] LIKE '%Emergency%'
			AND DATEDIFF(MINUTE, dtcall, HistoryDate) <= 30
			THEN 'Yes'
		ELSE CASE 
				WHEN [Priority] LIKE '%Routine%'
					AND (
						DATEADD(DAY, 1, CAST(dtcall AS DATE)) <= HistoryDate
						OR DATEDIFF(HOUR, dtcall, HistoryDate) <= 24
						)
					THEN 'Yes'
				ELSE 'No'
				END
		END AS 'CombineGoal'
FROM CTE 
WHERE orderby = 1
ORDER BY wonum
	,rownum

//END SELECT
